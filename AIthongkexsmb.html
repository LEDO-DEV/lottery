<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phần Mềm Lấy Full Xổ Số Kiến Thiết</title>
    <style>
        /* (Giữ nguyên style cũ) */
    </style>
</head>
<body>
    <div class="container">
        <h1>Phân Tích Kết Quả Xổ Số</h1>
        <div class="input-section">
            <label for="simulations">Số phiên chạy mô phỏng:</label>
            <input type="number" id="simulations" placeholder="Nhập số phiên chạy" min="1">
            <label for="region">Chọn miền:</label>
            <select id="region">
                <option value="Miền Bắc">Xổ Số Miền Bắc</option>
                <option value="Miền Trung">Xổ Số Miền Trung</option>
                <option value="Miền Nam">Xổ Số Miền Nam</option>
            </select>
            <label for="province">Chọn đài xổ số:</label>
            <select id="province">
                <!-- Các đài xổ số sẽ được điền qua JavaScript -->
            </select>
        </div>
        <button class="btn" id="startSimulation">Lấy Kết Quả Dự Đoán</button>
        <button class="btn" id="viewHistory">Xem Lịch Sử Quay</button>
        <div class="output-section" id="output">
            <div class="loading" id="loading">Đang chạy mô phỏng, vui lòng chờ...</div>
            <div class="result-section" id="result"></div>
        </div>
        <button class="btn" id="homeButton">Trang Chủ</button>
    </div>

    <script>
        const provinces = {
            "Miền Bắc": ["Hà Nội", "Thái Bình", "Bắc Ninh", "Hải Phòng", "Nam Định", "Quảng Ninh"],
            "Miền Trung": ["Bình Định", "Đà Nẵng", "Đắk Lắk", "Gia Lai", "Huế", "Khánh Hòa"],
            "Miền Nam": ["TP.HCM", "Cà Mau", "Đà Lạt", "Sóc Trăng", "Tiền Giang"]
        };

        const filePath = "history.txt"; // Đường dẫn file lịch sử trên server

        const updateProvinces = (region) => {
            const provinceSelect = document.getElementById('province');
            provinceSelect.innerHTML = '<option value="">Chọn đài xổ số</option>';
            provinces[region].forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });
        };

        const readHistory = async () => {
            try {
                const response = await fetch(filePath);
                const history = await response.text();
                return history.split("\n").filter(line => line.trim());
            } catch (error) {
                console.error("Không thể đọc file lịch sử:", error);
                return [];
            }
        };

        const saveHistory = async (entry) => {
            try {
                const response = await fetch(filePath, {
                    method: "POST",
                    body: entry,
                });
                return response.ok;
            } catch (error) {
                console.error("Không thể lưu lịch sử:", error);
            }
        };

        const checkAlreadyDrawn = async (region, province) => {
            const history = await readHistory();
            const today = new Date().toISOString().split("T")[0];
            return history.some(line => line.startsWith(`${today},${region},${province}`));
        };

        const monteCarloSimulation = (iterations) => {
            // (Giữ nguyên mã Monte Carlo như trong mã gốc)
        };

        const displayResults = (results, region, province) => {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `...`; // Hiển thị kết quả tương tự mã gốc
        };

        window.addEventListener('DOMContentLoaded', () => {
            updateProvinces("Miền Bắc");

            document.getElementById('region').addEventListener('change', (e) => {
                updateProvinces(e.target.value);
            });

            document.getElementById('startSimulation').addEventListener('click', async () => {
                const iterations = parseInt(document.getElementById('simulations').value);
                const region = document.getElementById('region').value;
                const province = document.getElementById('province').value;

                if (!iterations || !province) {
                    alert("Vui lòng nhập đầy đủ thông tin.");
                    return;
                }

                if (await checkAlreadyDrawn(region, province)) {
                    alert("Đài này đã quay hôm nay. Vui lòng thử lại ngày mai.");
                    return;
                }

                const loadingDiv = document.getElementById('loading');
                const outputDiv = document.getElementById('output');
                outputDiv.style.display = 'block';
                loadingDiv.style.display = 'block';

                setTimeout(async () => {
                    const results = monteCarloSimulation(iterations);
                    loadingDiv.style.display = 'none';
                    displayResults(results, region, province);

                    const today = new Date().toISOString().split("T")[0];
                    const entry = `${today},${region},${province},${JSON.stringify(results)}\n`;
                    await saveHistory(entry);
                }, 1000);
            });

            document.getElementById('viewHistory').addEventListener('click', async () => {
                const history = await readHistory();
                alert(history.join("\n"));
            });
        });
    </script>
</body>
</html>
